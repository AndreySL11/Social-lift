<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Social Lift Jump — Полная рабочая версия</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap');
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(to top, #0b3d91, #1e5fcf);
    font-family: 'Montserrat', sans-serif;
    color: #fff;
    user-select: none;
    overflow: hidden;
  }
  #gameCanvas {
    position: relative;
    z-index: 1;
    pointer-events: none; /* Клики проходят сквозь canvas */
    display: block;
    margin: 0 auto;
    background: transparent;
    border-radius: 16px;
    box-shadow: 0 0 30px #00bfff;
    max-width: 100vw;
    max-height: 80vh;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 320px;
    display: flex;
    justify-content: space-between;
    font-size: 20px;
    font-weight: 700;
    z-index: 10;
    pointer-events: none;
  }
  .screen {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 320px;
    max-width: 95vw;
    max-height: 80vh;
    padding: 20px;
    background: rgba(16, 42, 67, 0.95);
    border-radius: 20px;
    box-shadow: 0 0 40px #00bfffcc;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #fff;
    user-select: none;
    z-index: 10;
    display: none;
    overflow-y: auto;
    pointer-events: auto;
  }
  .screen.active {
    display: block;
  }
  button {
    position: relative;
    z-index: 20;
    pointer-events: auto;
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 18px;
    padding: 10px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    background-color: #00bfff;
    color: #000;
    margin: 8px;
    box-shadow: 0 0 20px #00bfffaa;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0099cc;
  }
  .shop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
    border-bottom: 1px solid #00bfff44;
    padding-bottom: 8px;
  }
  .skin-preview {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    margin-right: 12px;
    background-size: cover;
    background-position: center;
    border: 2px solid #00BFFF;
    flex-shrink: 0;
  }
  .boost-desc {
    font-size: 13px;
    color: #00BFFF;
    margin-left: 8px;
  }
  #ratingList {
    max-height: 200px;
    overflow-y: auto;
    text-align: left;
    margin-top: 10px;
    font-size: 16px;
  }
</style>
</head>
<body>

<canvas id="gameCanvas" width="320" height="480"></canvas>

<div id="ui">
  <div>Высота: <span id="score">0</span> м</div>
  <div>Монеты SL: <span id="coins">0</span></div>
</div>

<div id="menu" class="screen active">
  <h2>Social Lift Jump</h2>
  <button id="startGameBtn">Начать игру</button>
  <button id="openShopBtn">Магазин</button>
  <button id="openRatingBtn">Рейтинг</button>
</div>

<div id="gameOverScreen" class="screen">
  <h2>Игра окончена</h2>
  <p>Ваш результат: <span id="finalScore">0</span> м</p>
  <p>Монеты: <span id="finalCoins">0</span></p>
  <button id="restartGameBtn">Сыграть еще раз</button>
  <button id="goToMenuBtn1">Меню</button>
</div>

<div id="shopScreen" class="screen">
  <h2>Магазин</h2>
  <div>Монеты: <span id="shopCoins">0</span></div>
  <h3>Скины</h3>
  <div id="skinsList"></div>
  <h3>Усилители</h3>
  <div id="boostersList"></div>
  <button id="closeShopBtn">Назад</button>
</div>

<div id="ratingScreen" class="screen">
  <h2>Рейтинг игроков</h2>
  <div id="ratingList">Рейтинг доступен локально</div>
  <button id="closeRatingBtn">Назад</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Элементы
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  const scoreEl = document.getElementById('score');
  const coinsEl = document.getElementById('coins');
  const menu = document.getElementById('menu');
  const startGameBtn = document.getElementById('startGameBtn');
  const openShopBtn = document.getElementById('openShopBtn');
  const openRatingBtn = document.getElementById('openRatingBtn');
  const gameOverScreen = document.getElementById('gameOverScreen');
  const finalScoreEl = document.getElementById('finalScore');
  const finalCoinsEl = document.getElementById('finalCoins');
  const restartGameBtn = document.getElementById('restartGameBtn');
  const goToMenuBtn1 = document.getElementById('goToMenuBtn1');
  const shopScreen = document.getElementById('shopScreen');
  const skinsList = document.getElementById('skinsList');
  const boostersList = document.getElementById('boostersList');
  const shopCoinsEl = document.getElementById('shopCoins');
  const closeShopBtn = document.getElementById('closeShopBtn');
  const ratingScreen = document.getElementById('ratingScreen');
  const ratingList = document.getElementById('ratingList');
  const closeRatingBtn = document.getElementById('closeRatingBtn');

  // Игровые переменные
  let player = { x: width/2 - 18, y: height - 140, width: 36, height: 36, vy: 0, vx: 0, gravity: 0.35, jumpForce: -10, speedX: 0 };
  let platforms = [];
  const platformGap = 50;
  let scrollOffset = 0;
  let gameOver = false;
  let coinsCount = 0;
  let playerCoins = parseInt(localStorage.getItem('playerCoins')) || 0;
  let ownedSkins = JSON.parse(localStorage.getItem('ownedSkins') || '[0]');
  let selectedSkin = parseInt(localStorage.getItem('selectedSkin') || '0');
  let playerBoosts = JSON.parse(localStorage.getItem('playerBoosts') || '{"jump":0,"coin":0}');

  const skins = [
    { id: 0, name: 'Голубой', price: 0, color: '#00BFFF', img: null },
    { id: 1, name: 'Белый', price: 100, color: '#FFFFFF', img: null },
    { id: 2, name: 'Черный', price: 150, color: '#000000', img: null },
    { id: 3, name: 'Красный', price: 200, color: '#FF0000', img: null },
    { id: 4, name: 'Зелёный', price: 250, color: '#00FF00', img: null },
    { id: 5, name: 'Оранжевый', price: 300, color: '#FFA500', img: null },
    { id: 6, name: 'Розовый', price: 350, color: '#FFC0CB', img: null },
    { id: 7, name: 'Фиолетовый', price: 400, color: '#800080', img: null },
    { id: 8, name: 'Утка', price: 500, color: '#00BFFF', img: 'https://i.imgur.com/7yUvePI.png' },
    { id: 9, name: 'SL-Бренд', price: 750, color: '#00BFFF', img: 'https://i.imgur.com/3qXQ9kK.png' },
    { id: 10, name: 'Секретный', price: 0, color: '#FFD700', img: 'https://i.imgur.com/secretSkin.png', unlockScore: 5000 }
  ];

  const boosters = [
    { id: 'jump', name: 'Прыжок +2', price: 150, description: 'Увеличивает силу прыжка на 2' },
    { id: 'coin', name: 'Монеты x2', price: 200, description: 'Удваивает сбор монет' }
  ];

  class Platform {
    constructor(x, y, w, h, type='static') {
      this.x = x;
      this.y = y;
      this.w = w;
      this.h = h;
      this.type = type;
      this.moveDir = 1;
      this.moveSpeed = 1.5;
      this.moveRange = 60;
      this.baseX = x;
      this.coin = Math.random() < 0.35;
      this.coinCollected = false;
      this.broken = false;
      this.visible = true;
      this.disappearTimer = 0;
    }
    update() {
      if(this.type === 'moving') {
        this.x += this.moveSpeed * this.moveDir;
        if(this.x > this.baseX + this.moveRange || this.x < this.baseX - this.moveRange) {
          this.moveDir *= -1;
        }
      }
      if(this.type === 'breaking' && this.broken) {
        this.disappearTimer++;
        if(this.disappearTimer > 60) {
          this.visible = false;
        }
      }
    }
    draw(ctx) {
      if(!this.visible) return;
      ctx.fillStyle = this.type === 'breaking' ? '#ff6600' : '#00BFFF';
      ctx.fillRect(this.x, this.y, this.w, this.h);
      if(this.coin && !this.coinCollected) {
        const cx = this.x + this.w/2;
        const cy = this.y - 15;
        const r = 10;
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = '#B8860B';
        ctx.lineWidth = 1.5;
        ctx.stroke();
        ctx.fillStyle = '#333';
        ctx.font = 'bold 10px Montserrat, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('SL', cx, cy);
      }
    }
  }

  // Звёздный фон
  const stars = [];
  const starCount = 60;
  for(let i=0; i<starCount; i++) {
    stars.push({
      x: Math.random()*width,
      y: Math.random()*height,
      r: Math.random()*1.5 + 0.5,
      speed: (Math.random()*0.3)+0.05
    });
  }
  function drawStars() {
    ctx.fillStyle = '#fff';
    stars.forEach(s => {
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
      s.y += s.speed;
      if(s.y > height) s.y = 0;
    });
  }

  // Пиксельная утка
  function drawDuckPixeled(x, y, w, h) {
    const scale = w / 8;
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = '#FFD700';
    ctx.fillRect(scale*1, scale*2, scale*6, scale*4); // тело
    ctx.fillRect(scale*5, scale*0, scale*2, scale*2); // голова
    ctx.fillStyle = '#000';
    ctx.fillRect(scale*6, scale*1, scale*1, scale*1); // глаз
    ctx.fillStyle = '#FFA500';
    ctx.beginPath(); // клюв
    ctx.moveTo(scale*7, scale*2);
    ctx.lineTo(scale*8, scale*1.5);
    ctx.lineTo(scale*7, scale*3);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function drawPlayer() {
    const skin = skins.find(s => s.id === selectedSkin);
    if(skin && skin.img) {
      if(!skin._img) {
        skin._img = new Image();
        skin._img.src = skin.img;
      }
      ctx.drawImage(skin._img, player.x, player.y, player.width, player.height);
    } else {
      drawDuckPixeled(player.x, player.y, player.width, player.height);
    }
  }

  // Управление с плавным ускорением
  let leftPressed = false;
  let rightPressed = false;
  window.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft') leftPressed = true;
    if(e.key === 'ArrowRight') rightPressed = true;
  });
  window.addEventListener('keyup', e => {
    if(e.key === 'ArrowLeft') leftPressed = false;
    if(e.key === 'ArrowRight') rightPressed = false;
  });
  function handleKeyboardMovement() {
    const acceleration = 0.3;
    const maxSpeed = 5;
    if(leftPressed) {
      player.speedX = Math.max(player.speedX - acceleration, -maxSpeed);
    } else if(rightPressed) {
      player.speedX = Math.min(player.speedX + acceleration, maxSpeed);
    } else {
      if(player.speedX > 0) player.speedX = Math.max(player.speedX - acceleration, 0);
      else if(player.speedX < 0) player.speedX = Math.min(player.speedX + acceleration, 0);
    }
    player.vx = player.speedX;
  }

  function createPlatformAbove(y) {
    let x = Math.random() * (width - 80);
    let typeRand = Math.random();
    let type = 'static';
    if(typeRand < 0.2) type = 'moving';
    else if(typeRand < 0.35) type = 'breaking';
    return new Platform(x, y, 80, 15, type);
  }

  function createPlatforms() {
    platforms = [];
    platforms.push(new Platform(width/2 - 50, height - 100, 100, 15, 'static'));
    let y = height - 150;
    while(y > -2000) {
      platforms.push(createPlatformAbove(y));
      y -= platformGap + Math.random() * 20;
    }
  }

  function updatePlatforms() {
    platforms.forEach(p => p.update());
    platforms = platforms.filter(p => p.visible && p.y < height + 50);
    while(platforms.length < 15) {
      let minY = Math.min(...platforms.map(p => p.y));
      platforms.push(createPlatformAbove(minY - platformGap - Math.random() * 20));
    }
  }

  function updatePlayer() {
    player.vy += player.gravity;
    player.y += player.vy;
    player.x += player.vx;

    if(player.x + player.width < 0) player.x = width;
    else if(player.x > width) player.x = -player.width;

    for(let plat of platforms) {
      if(!plat.visible) continue;
      if(plat.type === 'breaking' && plat.broken && plat.disappearTimer > 30) continue;
      if(
        player.vy > 0 &&
        player.x + player.width > plat.x &&
        player.x < plat.x + plat.w &&
        player.y + player.height > plat.y &&
        player.y + player.height < plat.y + plat.h
      ) {
        player.y = plat.y - player.height;
        player.vy = player.jumpForce - (playerBoosts.jump || 0);
        if(plat.type === 'breaking') {
          plat.broken = true;
        }
        if(plat.coin && !plat.coinCollected) {
          plat.coinCollected = true;
          const coinAdd = (playerBoosts.coin ? 2 : 1);
          coinsCount += coinAdd;
          playerCoins += coinAdd;
          updateCoinsUI();
          saveProgress();
        }
        break;
      }
    }

    if(player.y > height) {
      gameOver = true;
      endGame();
    }
  }

  function drawPlatforms() {
    platforms.forEach(p => p.draw(ctx));
  }

  function gameLoop() {
    if(gameOver) return;
    ctx.clearRect(0, 0, width, height);
    drawStars();
    handleKeyboardMovement();
    updatePlayer();
    updatePlatforms();

    if(player.y < height/2) {
      let diff = (height/2) - player.y;
      player.y += diff;
      platforms.forEach(p => p.y += diff);
      scrollOffset += diff;
      coinsCount = Math.max(0, Math.floor(scrollOffset/10));
      scoreEl.textContent = coinsCount;
    }

    drawPlatforms();
    drawPlayer();

    requestAnimationFrame(gameLoop);
  }

  // Звёздный фон
  const stars = [];
  const starCount = 60;
  for(let i=0; i<starCount; i++) {
    stars.push({
      x: Math.random()*width,
      y: Math.random()*height,
      r: Math.random()*1.5 + 0.5,
      speed: (Math.random()*0.3)+0.05
    });
  }
  function drawStars() {
    ctx.fillStyle = '#fff';
    stars.forEach(s => {
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
      s.y += s.speed;
      if(s.y > height) s.y = 0;
    });
  }

  function updateCoinsUI() {
    coinsEl.textContent = playerCoins;
    shopCoinsEl.textContent = playerCoins;
  }

  function startGame() {
    gameOver = false;
    scrollOffset = 0;
    coinsCount = 0;
    player.x = width/2 - 18;
    player.y = height - 140;
    player.vx = 0;
    player.vy = 0;
    player.speedX = 0;
    player.gravity = 0.35;
    player.jumpForce = -10;
    createPlatforms();
    updateCoinsUI();
    scoreEl.textContent = '0';
    coinsEl.textContent = playerCoins;
    menu.classList.remove('active');
    gameOverScreen.classList.remove('active');
    shopScreen.classList.remove('active');
    ratingScreen.classList.remove('active');
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    finalScoreEl.textContent = coinsCount;
    finalCoinsEl.textContent = coinsCount;
    menu.classList.remove('active');
    gameOverScreen.classList.add('active');
    saveProgress();
  }

  // Прыжок по тапу/клику
  canvas.addEventListener('click', () => {
    if(gameOver) return;
    player.vy = player.jumpForce - (playerBoosts.jump || 0);
  });
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if(gameOver) return;
    player.vy = player.jumpForce - (playerBoosts.jump || 0);
  }, { passive: false });

  // Кнопки
  startGameBtn.addEventListener('click', startGame);
  restartGameBtn.addEventListener('click', startGame);
  goToMenuBtn1.addEventListener('click', () => {
    gameOverScreen.classList.remove('active');
    menu.classList.add('active');
  });
  openShopBtn.addEventListener('click', () => {
    renderShop();
    shopScreen.classList.add('active');
  });
  closeShopBtn.addEventListener('click', () => {
    shopScreen.classList.remove('active');
  });
  openRatingBtn.addEventListener('click', () => {
    const localLeaderboard = JSON.parse(localStorage.getItem('localLeaderboard') || '[]');
    if(localLeaderboard.length === 0) {
      ratingList.textContent = 'Рейтинг пуст';
    } else {
      ratingList.innerHTML = localLeaderboard.map((u,i) =>
        `<b>${i+1}.</b> ${u.name} <span style="float:right">${u.score} м</span>`
      ).join('<br>');
    }
    ratingScreen.classList.add('active');
  });
  closeRatingBtn.addEventListener('click', () => {
    ratingScreen.classList.remove('active');
  });

  // Магазин
  function renderShop() {
    shopCoinsEl.textContent = playerCoins;
    skinsList.innerHTML = skins.map(skin => {
      const owned = ownedSkins.includes(skin.id);
      const selected = selectedSkin === skin.id;
      const canUnlock = skin.unlockScore ? coinsCount >= skin.unlockScore : true;
      const bgStyle = skin.img ? `background-image:url(${skin.img});` : `background-color:${skin.color};`;
      return `
        <div class="shop-item">
          <div class="skin-preview" style="${bgStyle}"></div>
          <div>${skin.name} ${skin.unlockScore ? '(от ' + skin.unlockScore + ' очков)' : ''}</div>
          <div>
            ${owned ? (selected ? '<b>Выбрано</b>' : `<button data-id="${skin.id}">Выбрать</button>`) 
                    : (canUnlock ? `<button data-id="${skin.id}">Купить (${skin.price} SL)</button>` : '<i>Недоступен</i>')}
          </div>
        </div>
      `;
    }).join('');
    boostersList.innerHTML = boosters.map(b => {
      return `
        <div class="shop-item">
          <div>${b.name}<span class="boost-desc">${b.description}</span></div>
          <div><button data-id="${b.id}">Купить (${b.price} SL)</button></div>
        </div>
      `;
    }).join('');
  }
  skinsList.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      const id = parseInt(e.target.getAttribute('data-id'));
      if(e.target.textContent.includes('Купить')) buySkin(id);
      else if(e.target.textContent.includes('Выбрать')) selectSkin(id);
    }
  });
  boostersList.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      const id = e.target.getAttribute('data-id');
      buyBooster(id);
    }
  });
  function buySkin(id) {
    const skin = skins.find(s => s.id === id);
    if(playerCoins < skin.price) return alert('Недостаточно монет!');
    playerCoins -= skin.price;
    if(!ownedSkins.includes(id)) ownedSkins.push(id);
    saveProgress();
    updateCoinsUI();
    renderShop();
  }
  function selectSkin(id) {
    selectedSkin = id;
    saveProgress();
    renderShop();
  }
  function buyBooster(id) {
    const booster = boosters.find(b => b.id === id);
    if(playerCoins < booster.price) return alert('Недостаточно монет!');
    playerCoins -= booster.price;
    playerBoosts[id] = (playerBoosts[id] || 0) + 1;
    saveProgress();
    updateCoinsUI();
    renderShop();
  }
  function saveProgress() {
    localStorage.setItem('playerCoins', playerCoins);
    localStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
    localStorage.setItem('selectedSkin', selectedSkin);
    localStorage.setItem('playerBoosts', JSON.stringify(playerBoosts));
    let localLeaderboard = JSON.parse(localStorage.getItem('localLeaderboard') || '[]');
    localLeaderboard.push({name: 'Игрок', score: coinsCount});
    localLeaderboard.sort((a,b) => b.score - a.score);
    if(localLeaderboard.length > 10) localLeaderboard.length = 10;
    localStorage.setItem('localLeaderboard', JSON.stringify(localLeaderboard));
  }

  // Инициализация UI и кнопок
  updateCoinsUI();
  renderShop();
});
</script>
</body>
</html>


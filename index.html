<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Social Lift Jump</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; background: #87ceeb;
    font-family: Arial, sans-serif;
  }
  canvas {
    display: block; background: linear-gradient(#87ceeb, #ffffff);
  }
  #menu, #shop, #leaderboard, #gameOver {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); color: white;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 24px;
    z-index: 10;
  }
  #menu button, #shop button, #leaderboard button, #gameOver button {
    font-size: 20px; padding: 10px 20px; margin: 8px;
    cursor: pointer; border-radius: 8px;
  }
  #skinsContainer button {
    display: block; margin: 5px auto; width: 200px;
  }
  #scoreDisplay, #coinDisplay {
    position: fixed; top: 10px; left: 10px; font-size: 20px; color: black;
    background: rgba(255,255,255,0.7); padding: 5px 10px; border-radius: 8px;
    user-select: none;
  }
  #coinDisplay { left: auto; right: 10px; }
</style>
</head>
<body>

<canvas id="gameCanvas" width="400" height="700"></canvas>

<div id="scoreDisplay">Высота: 0 м</div>
<div id="coinDisplay">Монеты: 0</div>

<!-- Главное меню -->
<div id="menu">
  <h1>Social Lift Jump</h1>
  <button onclick="startGame()">Играть</button>
  <button onclick="openShop()">Магазин</button>
  <button onclick="openLeaderboard()">Рейтинг</button>
</div>

<!-- Магазин -->
<div id="shop" style="display:none; flex-wrap: wrap;">
  <h2>Магазин скинов</h2>
  <div id="skinsContainer"></div>
  <button onclick="closeShop()">Назад</button>
</div>

<!-- Рейтинг -->
<div id="leaderboard" style="display:none;">
  <h2>Лучший результат</h2>
  <div id="leaderboardList"></div>
  <button onclick="closeLeaderboard()">Назад</button>
</div>

<!-- Экран конца игры -->
<div id="gameOver" style="display:none; flex-direction: column; align-items: center;">
  <h2>Игра окончена!</h2>
  <p id="finalScore"></p>
  <button onclick="restartGame()">Играть заново</button>
  <button onclick="showMenu()">В меню</button>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const WIDTH = canvas.width;
const HEIGHT = canvas.height;

let player, platforms, enemies, coins;
let cameraY = 0;
let velocityY = 0;
const gravity = 0.4;
const jumpPower = -12;
let score = 0;
let coinBalance = parseInt(localStorage.getItem("coins")) || 0;
let highScore = parseInt(localStorage.getItem("highScore")) || 0;
let gameRunning = false;
let selectedSkin = localStorage.getItem("skin") || "default";

const skins = {
  default: { color: "black", price: 0 },
  blue: { color: "blue", price: 50 },
  green: { color: "green", price: 100 },
  red: { color: "red", price: 200 },
  purple: { color: "purple", price: 300 },
  orange: { color: "orange", price: 400 }
};

// Управление
let keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// Мобильное управление (касания)
let touchX = null;
canvas.addEventListener("touchstart", e => {
  if (e.touches.length === 1) touchX = e.touches[0].clientX;
});
canvas.addEventListener("touchmove", e => {
  if (e.touches.length === 1) {
    let deltaX = e.touches[0].clientX - touchX;
    player.x += deltaX * 0.3;
    if(player.x < 0) player.x = 0;
    if(player.x > WIDTH - player.w) player.x = WIDTH - player.w;
    touchX = e.touches[0].clientX;
  }
});
canvas.addEventListener("touchend", e => {
  touchX = null;
});

function resetGame() {
  player = { x: WIDTH/2 - 15, y: HEIGHT - 100, w: 30, h: 30 };
  velocityY = 0;
  cameraY = 0;
  score = 0;

  // Стартовая платформа
  platforms = [{x: player.x - 15, y: player.y + player.h, w: 60, h: 12}];
  // Несколько платформ выше для старта
  for (let i=1; i<10; i++) {
    platforms.push({
      x: Math.random()*(WIDTH-60),
      y: HEIGHT - 100 - i*70,
      w: 60,
      h: 12
    });
  }

  enemies = [];
  coins = [];
  spawnCoinsAndEnemies();

  updateScoreAndCoinsDisplay();
}

function spawnCoinsAndEnemies() {
  coins = [];
  enemies = [];
  for (let i = 0; i < platforms.length; i++) {
    let p = platforms[i];
    // Монеты над платформами с вероятностью 50%
    if (Math.random() < 0.5) {
      coins.push({x: p.x + p.w/2 - 6, y: p.y - 20, w: 12, h: 12});
    }
    // Враги на платформах с вероятностью 20%
    if (Math.random() < 0.2 && p.y < HEIGHT - 200) {
      enemies.push({x: p.x + p.w/2 - 15, y: p.y - 30, w: 30, h: 30, dir: 1, speed: 1 + Math.random()});
    }
  }
}

function startGame() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("shop").style.display = "none";
  document.getElementById("leaderboard").style.display = "none";
  document.getElementById("gameOver").style.display = "none";

  resetGame();
  gameRunning = true;
  requestAnimationFrame(gameLoop);
}

function restartGame() {
  startGame();
}

function showMenu() {
  document.getElementById("menu").style.display = "flex";
  document.getElementById("shop").style.display = "none";
  document.getElementById("leaderboard").style.display = "none";
  document.getElementById("gameOver").style.display = "none";
  gameRunning = false;
}

function openShop() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("shop").style.display = "flex";
  const container = document.getElementById("skinsContainer");
  container.innerHTML = "";

  for (const key in skins) {
    const skin = skins[key];
    const unlocked = localStorage.getItem("unlocked_" + key) === "true" || skin.price === 0;
    const btn = document.createElement("button");
    btn.innerText = `${key.toUpperCase()} — ${skin.price ? skin.price + " монет" : "Бесплатно"}` + (unlocked ? " (куплен)" : "");

    btn.disabled = false;
    btn.style.backgroundColor = unlocked ? "#4CAF50" : "#f44336";

    btn.onclick = () => {
      if (unlocked) {
        selectedSkin = key;
        localStorage.setItem("skin", key);
        alert(`Скин "${key}" применён!`);
      } else {
        if (coinBalance >= skin.price) {
          coinBalance -= skin.price;
          localStorage.setItem("coins", coinBalance);
          localStorage.setItem("unlocked_" + key, "true");
          alert(`Скин "${key}" куплен и применён!`);
          selectedSkin = key;
          localStorage.setItem("skin", key);
          openShop(); // обновить магазин
        } else {
          alert("Недостаточно монет");
        }
      }
      updateScoreAndCoinsDisplay();
    };
    container.appendChild(btn);
  }
}

function closeShop() {
  document.getElementById("shop").style.display = "none";
  document.getElementById("menu").style.display = "flex";
}

function openLeaderboard() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("leaderboard").style.display = "flex";
  document.getElementById("leaderboardList").innerText = `Лучший результат: ${highScore} м`;
}

function closeLeaderboard() {
  document.getElementById("leaderboard").style.display = "none";
  document.getElementById("menu").style.display = "flex";
}

function updateScoreAndCoinsDisplay() {
  document.getElementById("scoreDisplay").innerText = `Высота: ${score} м`;
  document.getElementById("coinDisplay").innerText = `Монеты: ${coinBalance}`;
}

function drawBackground() {
  // День и ночь: циклично меняем цвет фона
  let dayDuration = 600; // кадров (~10 секунд)
  let cycle = (Date.now()/100) % dayDuration;
  let ratio = Math.abs(cycle - dayDuration/2) / (dayDuration/2); // 0..1..0
  let r = Math.floor(135 + 120 * (1 - ratio)); // меняем голубой
  let g = Math.floor(206 + 49 * (1 - ratio));
  let b = Math.floor(235 + 20 * (1 - ratio));
  ctx.fillStyle = `rgb(${r},${g},${b})`;
  ctx.fillRect(0, 0, WIDTH, HEIGHT);
}

function drawPlatform(p) {
  ctx.fillStyle = "#654321";
  ctx.fillRect(p.x, p.y - cameraY, p.w, p.h);
}

function drawPlayer() {
  ctx.fillStyle = skins[selectedSkin]?.color || "black";
  ctx.fillRect(player.x, player.y - cameraY, player.w, player.h);
}

function drawEnemy(e) {
  ctx.fillStyle = "red";
  ctx.fillRect(e.x, e.y - cameraY, e.w, e.h);
}

function drawCoin(c) {
  ctx.fillStyle = "yellow";
  ctx.beginPath();
  ctx.arc(c.x + c.w/2, c.y - cameraY + c.h/2, c.w/2, 0, 2 * Math.PI);
  ctx.fill();
}

function update() {
  // Движение игрока по горизонтали (клавиши/тач)
  if (keys["arrowleft"] || keys["a"]) {
    player.x -= 5;
  }
  if (keys["arrowright"] || keys["d"]) {
    player.x += 5;
  }
  if (player.x < 0) player.x = 0;
  if (player.x > WIDTH - player.w) player.x = WIDTH - player.w;

  // Гравитация и прыжок
  velocityY += gravity;
  player.y += velocityY;

  // Камера следует за игроком вверх
  if (player.y - cameraY < HEIGHT/3) {
    cameraY = player.y - HEIGHT/3;
  }

  // Проверка столкновений с платформами (если падаем вниз)
  if (velocityY > 0) {
    for (let p of platforms) {
      if (
        player.x + player.w > p.x &&
        player.x < p.x + p.w &&
        player.y + player.h > p.y &&
        player.y + player.h < p.y + p.h + velocityY &&
        player.y + player.h - velocityY <= p.y
      ) {
        player.y = p.y - player.h;
        velocityY = jumpPower; // прыжок
        break;
      }
    }
  }

  // Проверка сбора монет
  for (let i = coins.length - 1; i >= 0; i--) {
    let c = coins[i];
    if (
      player.x < c.x + c.w &&
      player.x + player.w > c.x &&
      player.y < c.y + c.h &&
      player.y + player.h > c.y
    ) {
      coins.splice(i, 1);
      coinBalance++;
      localStorage.setItem("coins", coinBalance);
      updateScoreAndCoinsDisplay();
    }
  }

  // Движение врагов (патрулирование)
  for (let e of enemies) {
    e.x += e.dir * e.speed;
    if (e.x < 0 || e.x + e.w > WIDTH) e.dir *= -1;
  }

  // Проверка столкновения с врагами (конец игры)
  for (let e of enemies) {
    if (
      player.x < e.x + e.w &&
      player.x + player.w > e.x &&
      player.y < e.y + e.h &&
      player.y + player.h > e.y
    ) {
      endGame();
      return;
    }
  }

  // Удаляем платформы, которые ниже экрана
  platforms = platforms.filter(p => p.y - cameraY < HEIGHT + 50);

  // Генерация новых платформ сверху
  while (platforms.length < 10) {
    let last = platforms[platforms.length - 1];
    let newY = last.y - 70;
    let newX = Math.random() * (WIDTH - 60);
    platforms.push({ x: newX, y: newY, w: 60, h: 12 });
  }

  // Обновление счета (максимальная высота)
  let playerHeight = Math.round(cameraY);
  if (playerHeight > score) {
    score = playerHeight;
    updateScoreAndCoinsDisplay();
  }
}

function draw() {
  drawBackground();

  for (let p of platforms) drawPlatform(p);
  for (let c of coins) drawCoin(c);
  for (let e of enemies) drawEnemy(e);
  drawPlayer();
}

function gameLoop() {
  if (!gameRunning) return;
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function endGame() {
  gameRunning = false;
  // Обновляем рекорд
  if (score > highScore) {
    highScore = score;
    localStorage.setItem("highScore", highScore);
  }

  // Обновляем экран конца игры
  document.getElementById("finalScore").innerText = `Вы прыгнули на ${score} м!\nМонеты: ${coinBalance}`;
  document.getElementById("gameOver").style.display = "flex";
}

updateScoreAndCoinsDisplay();
</script>

</body>
</html>

